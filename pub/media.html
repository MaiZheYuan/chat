<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Media</title>
    <style>
        .link-form{
            font-size: 50px;
        }
        .link-form input{
            height: 50px;
        }
        .link-form span:hover{
            color: #f00;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="link-form">
    <label for="user">你的id</label><input type="text" id="user"><span id="join">join</span>
</div>
<div class="link-form">
    <label for="link-to">要连接的id</label><input type="text" id="link-to"><span id="link">join</span>
</div>
<div id="test"></div>
<video id="video" autoplay></video>
</body>

<script src="socket.io/socket.io.js"></script>
<script type="text/javascript">
    var chatTool = {};
    var video = document.querySelector('video');
    var iceServer = {
        "iceServers": [{
            "urls": "stun:stun.ideasip.com"
        }]
    };
    var PeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
    var pc = new PeerConnection(iceServer);
    chatTool.socket = io.connect();
    pc.ontrack = function(obj) {
        video.srcObject = obj.stream;
    };
    //主动呼叫，打开摄像头
    function mediaStart(userName,linkUserName) {
        var getUserMedia = navigator.mediaDevices.getUserMedia({ audio: false, video: true });
        getUserMedia
            .then(start)
            .catch(error=>{
                test.innerText = JSON.stringify(error);
                console.error("mediaStart,getUserMedia"+error)
            });
        function start(mediaStream) {
            video.srcObject = mediaStream;
            alert("getUserMedia");
            pc.addStream(mediaStream);
            //创建并发送视频请求
            pc.createOffer(function(offer) {
                pc.setLocalDescription(new RTCSessionDescription(offer), function() {
                    console.log("linkToEmit");
                    alert("linkToEmit");
                    chatTool.socket.emit("linkTo",{user:userName,man:linkUserName,offer:offer});
                    // send the offer to a server to be forwarded to the friend you're calling.
                }, error=>{console.error("mediaStart,setLocalDescription"+error)});
            }, error=>{console.error("mediaStart,createOffer"+error)});
        }
    }
    //被呼叫，同意连接
    function wasCalled(val){
        var offer = val.offer;
        var getUserMedia = navigator.mediaDevices.getUserMedia({ audio: false, video: true });
        console.log("linkReqOn");
        getUserMedia
            .then(answer)
            .catch(error=>{
                console.error("wasCalled,getUserMedia"+error)
            });
        function answer(stream) {
            pc.ontrack({stream: stream});
            pc.addStream(stream);
            pc.setRemoteDescription(new RTCSessionDescription(offer), function() {
                pc.createAnswer(function(answer) {
                    pc.setLocalDescription(new RTCSessionDescription(answer), function() {
                        console.log("answerEmit");
                        test.innerText = val.man;
                        chatTool.socket.emit("linkAnswer",{man:val.man,answer:answer});
                    }, error=>{console.error("wasCalled,setLocalDescription"+error)});
                }, error=>{console.error("wasCalled,setLocalDescription"+error)});
            }, error=>{console.error("wasCalled,setRemoteDescription"+error)});
        }
    }
</script>
<script type="text/javascript">
    var test = document.querySelector("#test");
    var user = document.querySelector("#user");
    var join = document.querySelector("#join");
    var linkUser = document.querySelector("#link-to");
    var link = document.querySelector("#link");
    var userName,linkUserName;
    join.onclick = function () {
        userName = user.value;
        chatTool.socket.emit("joinRoom",{id:userName});
    };
    link.onclick = function () {
        linkUserName = linkUser.value;
        mediaStart(userName,linkUserName);
    }
    //监听别人发起的视频请求
    chatTool.socket.on("linkReq",function(val){
        wasCalled(val);
    });
    //监听自己发起的请求被成功应答
    chatTool.socket.on("linkOk",function (val) {
        var answer = val.answer;
        console.log("okOn");
        pc.setRemoteDescription(
            new RTCSessionDescription(answer),
            function() { },
            error=>{ console.log("linkOk"+error) }
        );
    });

</script>

</html>